<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recipe Upload - Mom's Recipe Box</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Georgia', serif;
      background: linear-gradient(180deg, #fef9f3 0%, #f5ebe0 50%, #efe4d4 100%);
      min-height: 100vh;
      padding: 20px;
      font-size: 18px;
      line-height: 1.6;
      color: #4a3728;
    }
    
    .container {
      max-width: 700px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #5c4033 0%, #3d2a1f 100%);
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(92, 64, 51, 0.3);
    }
    
    h1 {
      font-size: 1.8rem;
      color: #fff8f0;
      margin-bottom: 8px;
    }
    
    .subtitle {
      color: #d4c4b0;
      font-size: 1rem;
    }
    
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #8b4513;
      text-decoration: none;
      font-size: 1rem;
    }
    
    .back-link:hover {
      text-decoration: underline;
    }
    
    /* PIN Entry */
    .pin-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #5c4033 0%, #3d2a1f 100%);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .pin-overlay.hidden { display: none; }
    
    .pin-box {
      background: #fffcf7;
      border-radius: 24px;
      padding: 40px;
      text-align: center;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    
    .pin-box h2 {
      color: #5c4033;
      margin-bottom: 10px;
      font-size: 1.6rem;
    }
    
    .pin-box p {
      color: #8b7355;
      margin-bottom: 30px;
    }
    
    .pin-input {
      width: 100%;
      padding: 18px;
      font-size: 2rem;
      text-align: center;
      border: 3px solid #d4c4b0;
      border-radius: 12px;
      font-family: inherit;
      letter-spacing: 0.5em;
      margin-bottom: 20px;
    }
    
    .pin-input:focus {
      outline: none;
      border-color: #8b4513;
    }
    
    .pin-error {
      color: #c41e3a;
      margin-bottom: 20px;
      font-weight: bold;
      min-height: 1.5em;
    }
    
    /* Cards */
    .card {
      background: #fffcf7;
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(92, 64, 51, 0.12);
    }
    
    .card h2 {
      color: #5c4033;
      margin-bottom: 16px;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .step-number {
      background: #8b4513;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }
    
    /* Upload Area */
    .upload-area {
      border: 3px dashed #d4c4b0;
      border-radius: 16px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #faf7f2;
    }
    
    .upload-area:hover {
      border-color: #8b4513;
      background: #f5f0e8;
    }
    
    .upload-area.has-image {
      border-style: solid;
      border-color: #2e8b57;
      padding: 20px;
    }
    
    .upload-area input {
      display: none;
    }
    
    .upload-icon {
      font-size: 3rem;
      margin-bottom: 10px;
    }
    
    .upload-text {
      color: #8b7355;
      font-size: 1.1rem;
    }
    
    .preview-image {
      max-width: 100%;
      max-height: 400px;
      border-radius: 12px;
      margin-top: 15px;
    }
    
    /* Buttons */
    .btn {
      background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
      color: white;
      border: none;
      padding: 16px 28px;
      border-radius: 30px;
      font-family: inherit;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(196, 30, 58, 0.3);
      min-height: 54px;
      width: 100%;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(196, 30, 58, 0.4);
    }
    
    .btn:disabled {
      background: #bbb;
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #2e8b57 0%, #1a5235 100%);
      box-shadow: 0 4px 15px rgba(46, 139, 87, 0.3);
    }
    
    .btn-secondary:hover {
      box-shadow: 0 6px 20px rgba(46, 139, 87, 0.4);
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid #8b4513;
      color: #8b4513;
      box-shadow: none;
    }
    
    .btn-outline:hover {
      background: #8b4513;
      color: white;
      box-shadow: none;
      transform: none;
    }
    
    /* Form */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #5c4033;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 14px;
      border: 2px solid #d4c4b0;
      border-radius: 10px;
      font-family: inherit;
      font-size: 1rem;
      background: #fff;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #8b4513;
    }
    
    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .form-group .help-text {
      font-size: 0.9rem;
      color: #8b7355;
      margin-top: 6px;
    }
    
    /* Ingredient/Direction Lists */
    .list-editor {
      background: #faf7f2;
      border-radius: 10px;
      padding: 16px;
    }
    
    .list-item {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    
    .list-item input {
      flex: 1;
    }
    
    .list-item .remove-btn {
      background: #c41e3a;
      color: white;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    
    .add-btn {
      background: none;
      border: 2px dashed #8b4513;
      color: #8b4513;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      font-family: inherit;
      font-size: 1rem;
      margin-top: 10px;
    }
    
    .add-btn:hover {
      background: #8b4513;
      color: white;
      border-style: solid;
    }
    
    /* Status Messages */
    .status {
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .status.loading {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    .status.success {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .status.error {
      background: #ffebee;
      color: #c62828;
    }
    
    .hidden { display: none !important; }
    
    /* API Key Input */
    .api-key-section {
      background: #fff3cd;
      border: 2px solid #daa520;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .api-key-section h3 {
      color: #856404;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    
    .api-key-section p {
      color: #856404;
      font-size: 0.95rem;
      margin-bottom: 15px;
    }
    
    .api-key-section input {
      width: 100%;
      padding: 12px;
      border: 2px solid #daa520;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    @media (max-width: 600px) {
      body { padding: 12px; }
      h1 { font-size: 1.5rem; }
      .card { padding: 20px; }
    }
  </style>
</head>
<body>
  <!-- PIN Entry -->
  <div class="pin-overlay" id="pinOverlay">
    <div class="pin-box">
      <h2>üîê Admin Access</h2>
      <p>Enter the family PIN</p>
      <input type="password" class="pin-input" id="pinInput" maxlength="4" inputmode="numeric" pattern="[0-9]*" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <div class="pin-error" id="pinError"></div>
      <button class="btn" id="pinSubmit">Enter</button>
    </div>
  </div>

  <div class="container">
    <a href="index.html" class="back-link">‚Üê Back to Recipe Box</a>
    
    <header>
      <h1>üì∏ Upload Recipe Card</h1>
      <p class="subtitle">Take a photo of a handwritten recipe card</p>
    </header>
    
    <!-- API Key (stored in browser) -->
    <div class="api-key-section" id="apiKeySection">
      <h3>üîë Claude API Key Required</h3>
      <p>Your API key is stored locally in your browser and never sent to our servers.</p>
      <input type="password" id="claudeApiKey" placeholder="sk-ant-api..." autocomplete="off">
      <button class="btn" style="margin-top: 15px;" id="saveApiKey">Save API Key</button>
    </div>
    
    <!-- Step 1: Upload -->
    <div class="card" id="step1">
      <h2><span class="step-number">1</span> Upload Photo</h2>
      <div class="upload-area" id="uploadArea">
        <input type="file" id="imageInput" accept="image/*" capture="environment">
        <div class="upload-icon">üì∑</div>
        <p class="upload-text">Tap to take photo or choose file</p>
      </div>
    </div>
    
    <!-- Step 2: Process -->
    <div class="card hidden" id="step2">
      <h2><span class="step-number">2</span> Read Recipe</h2>
      <p style="margin-bottom: 20px; color: #8b7355;">Claude AI will read the handwriting and extract the recipe.</p>
      <button class="btn" id="processBtn">ü§ñ Read with Claude</button>
      <div class="status hidden" id="processStatus"></div>
    </div>
    
    <!-- Step 3: Review & Save -->
    <div class="card hidden" id="step3">
      <h2><span class="step-number">3</span> Review & Save</h2>
      <p style="margin-bottom: 20px; color: #8b7355;">Check the extracted recipe and fix any mistakes.</p>
      
      <form id="recipeForm">
        <div class="form-group">
          <label for="recipeName">Recipe Name</label>
          <input type="text" id="recipeName" required>
        </div>
        
        <div class="form-group">
          <label for="recipeSource">From (who's recipe?)</label>
          <input type="text" id="recipeSource" placeholder="e.g., Grandma Betty">
        </div>
        
        <div class="form-group">
          <label for="recipePreview">Short Description</label>
          <input type="text" id="recipePreview" placeholder="One sentence about what this makes">
        </div>
        
        <div class="form-group">
          <label>Ingredients</label>
          <div class="list-editor" id="ingredientsList"></div>
          <button type="button" class="add-btn" id="addIngredient">+ Add Ingredient</button>
        </div>
        
        <div class="form-group">
          <label>Directions</label>
          <div class="list-editor" id="directionsList"></div>
          <button type="button" class="add-btn" id="addDirection">+ Add Step</button>
        </div>
        
        <div class="form-group">
          <label for="recipeTip">Mom's Tip (optional)</label>
          <textarea id="recipeTip" placeholder="Any special notes or tips"></textarea>
        </div>
        
        <button type="submit" class="btn btn-secondary">üíæ Save Recipe</button>
      </form>
      
      <div class="status hidden" id="saveStatus"></div>
    </div>
    
    <!-- Success -->
    <div class="card hidden" id="successCard">
      <h2 style="color: #2e8b57;">‚úÖ Recipe Saved!</h2>
      <p style="margin: 20px 0;">The recipe has been added to Mom's Recipe Box.</p>
      <button class="btn" id="addAnother">üì∏ Add Another Recipe</button>
      <a href="index.html" class="btn btn-outline" style="display: block; text-align: center; margin-top: 15px; text-decoration: none;">View Recipe Box</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // Supabase config
    const SUPABASE_URL = 'https://pieukthfqinsiygjvwnz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpZXVrdGhmcWluc2l5Z2p2d256Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0OTYyNTIsImV4cCI6MjA4MTA3MjI1Mn0.3RxUTgmpD-yn3N7g8HaJLD9LvKUUQEHZ8XA38XucfjM';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let currentImage = null;
    let currentImageBase64 = null;
    let parsedRecipe = null;
    
    // PIN check
    function isAuthenticated() {
      return localStorage.getItem('recipes_pin_verified') === 'true';
    }
    
    function showPinOverlay(show) {
      document.getElementById('pinOverlay').classList.toggle('hidden', !show);
    }
    
    async function verifyPin(pin) {
      try {
        const { data, error } = await supabase
          .from('app_config')
          .select('value')
          .eq('key', 'pin')
          .single();
        if (error) throw error;
        return data.value === pin;
      } catch (err) {
        console.error('PIN check error:', err);
        return false;
      }
    }
    
    // API Key management
    function getApiKey() {
      return localStorage.getItem('claude_api_key');
    }
    
    function setApiKey(key) {
      localStorage.setItem('claude_api_key', key);
    }
    
    function checkApiKey() {
      const key = getApiKey();
      if (key) {
        document.getElementById('apiKeySection').classList.add('hidden');
        document.getElementById('claudeApiKey').value = key;
      }
    }
    
    // Image handling
    function handleImageSelect(file) {
      if (!file) return;
      
      currentImage = file;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        currentImageBase64 = e.target.result.split(',')[1]; // Remove data:image/...;base64,
        
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.classList.add('has-image');
        uploadArea.innerHTML = `
          <img src="${e.target.result}" class="preview-image" alt="Recipe card">
          <p class="upload-text" style="margin-top: 15px;">Tap to change photo</p>
          <input type="file" id="imageInput" accept="image/*" capture="environment">
        `;
        
        // Re-attach listener
        document.getElementById('imageInput').addEventListener('change', (e) => {
          if (e.target.files[0]) handleImageSelect(e.target.files[0]);
        });
        
        // Show step 2
        document.getElementById('step2').classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
    
    // Claude OCR
    async function processWithClaude() {
      const apiKey = getApiKey();
      if (!apiKey) {
        alert('Please enter your Claude API key first');
        document.getElementById('apiKeySection').classList.remove('hidden');
        return;
      }
      
      if (!currentImageBase64) {
        alert('Please upload an image first');
        return;
      }
      
      const statusEl = document.getElementById('processStatus');
      const processBtn = document.getElementById('processBtn');
      
      statusEl.className = 'status loading';
      statusEl.textContent = 'Reading recipe... this may take a moment';
      statusEl.classList.remove('hidden');
      processBtn.disabled = true;
      
      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 2000,
            messages: [{
              role: 'user',
              content: [
                {
                  type: 'image',
                  source: {
                    type: 'base64',
                    media_type: currentImage.type,
                    data: currentImageBase64
                  }
                },
                {
                  type: 'text',
                  text: `You are extracting a recipe from a handwritten recipe card. The handwriting may be cursive.

Analyze this image and extract:
1. Recipe name/title
2. Who it's from (if noted, like "From the kitchen of...")
3. All ingredients with amounts
4. All directions/steps
5. Any tips, notes, or special instructions

Return ONLY valid JSON in this exact format (no markdown, no explanation):
{
  "name": "Recipe Name",
  "source": "Person's Name or null",
  "preview": "One sentence description of what this recipe makes",
  "ingredients": [
    {"item": "flour", "amount": "2 cups", "category": "Baking"},
    {"item": "butter", "amount": "1 stick", "category": "Dairy"}
  ],
  "directions": [
    "Step one instructions",
    "Step two instructions"
  ],
  "tip": "Any tips or notes, or null if none"
}

Categories should be one of: Dairy, Baking, Nuts, Snacks, Produce, Meat, Spices, Other

If you cannot read something clearly, make your best guess and add [?] after it.
If the image shows both sides of a card, extract from both.`
                }
              ]
            }]
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error?.message || 'API request failed');
        }
        
        const data = await response.json();
        const content = data.content[0].text;
        
        // Parse the JSON response
        parsedRecipe = JSON.parse(content);
        
        statusEl.className = 'status success';
        statusEl.textContent = '‚úì Recipe extracted successfully!';
        
        // Populate form
        populateForm(parsedRecipe);
        document.getElementById('step3').classList.remove('hidden');
        
      } catch (err) {
        console.error('OCR error:', err);
        statusEl.className = 'status error';
        statusEl.textContent = 'Error: ' + err.message;
      } finally {
        processBtn.disabled = false;
      }
    }
    
    // Form population
    function populateForm(recipe) {
      document.getElementById('recipeName').value = recipe.name || '';
      document.getElementById('recipeSource').value = recipe.source || '';
      document.getElementById('recipePreview').value = recipe.preview || '';
      document.getElementById('recipeTip').value = recipe.tip || '';
      
      // Ingredients
      const ingredientsList = document.getElementById('ingredientsList');
      ingredientsList.innerHTML = '';
      (recipe.ingredients || []).forEach((ing, i) => {
        addIngredientRow(ing.amount, ing.item, ing.category);
      });
      
      // Directions
      const directionsList = document.getElementById('directionsList');
      directionsList.innerHTML = '';
      (recipe.directions || []).forEach((dir, i) => {
        addDirectionRow(dir);
      });
    }
    
    function addIngredientRow(amount = '', item = '', category = 'Other') {
      const list = document.getElementById('ingredientsList');
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <input type="text" placeholder="Amount" value="${amount}" class="ing-amount" style="flex: 0.7;">
        <input type="text" placeholder="Ingredient" value="${item}" class="ing-item">
        <select class="ing-category" style="flex: 0.6; padding: 10px; border: 2px solid #d4c4b0; border-radius: 8px;">
          <option value="Baking" ${category === 'Baking' ? 'selected' : ''}>Baking</option>
          <option value="Dairy" ${category === 'Dairy' ? 'selected' : ''}>Dairy</option>
          <option value="Nuts" ${category === 'Nuts' ? 'selected' : ''}>Nuts</option>
          <option value="Snacks" ${category === 'Snacks' ? 'selected' : ''}>Snacks</option>
          <option value="Produce" ${category === 'Produce' ? 'selected' : ''}>Produce</option>
          <option value="Meat" ${category === 'Meat' ? 'selected' : ''}>Meat</option>
          <option value="Spices" ${category === 'Spices' ? 'selected' : ''}>Spices</option>
          <option value="Other" ${category === 'Other' ? 'selected' : ''}>Other</option>
        </select>
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
      `;
      list.appendChild(div);
    }
    
    function addDirectionRow(text = '') {
      const list = document.getElementById('directionsList');
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <input type="text" placeholder="Step..." value="${text}">
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
      `;
      list.appendChild(div);
    }
    
    // Save recipe
    async function saveRecipe(e) {
      e.preventDefault();
      
      const statusEl = document.getElementById('saveStatus');
      statusEl.className = 'status loading';
      statusEl.textContent = 'Saving recipe...';
      statusEl.classList.remove('hidden');
      
      // Gather form data
      const ingredients = [];
      document.querySelectorAll('#ingredientsList .list-item').forEach(row => {
        const amount = row.querySelector('.ing-amount').value.trim();
        const item = row.querySelector('.ing-item').value.trim();
        const category = row.querySelector('.ing-category').value;
        if (item) {
          ingredients.push({ amount, item, category });
        }
      });
      
      const directions = [];
      document.querySelectorAll('#directionsList .list-item input').forEach(input => {
        const text = input.value.trim();
        if (text) directions.push(text);
      });
      
      const recipe = {
        name: document.getElementById('recipeName').value.trim(),
        source: document.getElementById('recipeSource').value.trim() || null,
        preview: document.getElementById('recipePreview').value.trim() || null,
        ingredients: ingredients,
        directions: directions,
        tip: document.getElementById('recipeTip').value.trim() || null
      };
      
      try {
        const { data, error } = await supabase
          .from('recipes')
          .insert([recipe]);
        
        if (error) throw error;
        
        // Show success
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step3').classList.add('hidden');
        document.getElementById('successCard').classList.remove('hidden');
        
      } catch (err) {
        console.error('Save error:', err);
        statusEl.className = 'status error';
        statusEl.textContent = 'Error saving: ' + err.message;
      }
    }
    
    // Reset form
    function resetForm() {
      currentImage = null;
      currentImageBase64 = null;
      parsedRecipe = null;
      
      document.getElementById('uploadArea').classList.remove('has-image');
      document.getElementById('uploadArea').innerHTML = `
        <input type="file" id="imageInput" accept="image/*" capture="environment">
        <div class="upload-icon">üì∑</div>
        <p class="upload-text">Tap to take photo or choose file</p>
      `;
      
      document.getElementById('imageInput').addEventListener('change', (e) => {
        if (e.target.files[0]) handleImageSelect(e.target.files[0]);
      });
      
      document.getElementById('step1').classList.remove('hidden');
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('step3').classList.add('hidden');
      document.getElementById('successCard').classList.add('hidden');
      document.getElementById('processStatus').classList.add('hidden');
      document.getElementById('saveStatus').classList.add('hidden');
      
      document.getElementById('recipeForm').reset();
      document.getElementById('ingredientsList').innerHTML = '';
      document.getElementById('directionsList').innerHTML = '';
    }
    
    // Event Listeners
    document.getElementById('pinSubmit').addEventListener('click', async () => {
      const pin = document.getElementById('pinInput').value;
      const errorEl = document.getElementById('pinError');
      
      if (!pin) {
        errorEl.textContent = 'Please enter the PIN';
        return;
      }
      
      const valid = await verifyPin(pin);
      if (valid) {
        localStorage.setItem('recipes_pin_verified', 'true');
        showPinOverlay(false);
      } else {
        errorEl.textContent = 'Incorrect PIN';
        document.getElementById('pinInput').value = '';
      }
    });
    
    document.getElementById('pinInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('pinSubmit').click();
    });
    
    document.getElementById('saveApiKey').addEventListener('click', () => {
      const key = document.getElementById('claudeApiKey').value.trim();
      if (key) {
        setApiKey(key);
        document.getElementById('apiKeySection').classList.add('hidden');
      }
    });
    
    document.getElementById('uploadArea').addEventListener('click', () => {
      document.getElementById('imageInput').click();
    });
    
    document.getElementById('imageInput').addEventListener('change', (e) => {
      if (e.target.files[0]) handleImageSelect(e.target.files[0]);
    });
    
    document.getElementById('processBtn').addEventListener('click', processWithClaude);
    
    document.getElementById('addIngredient').addEventListener('click', () => addIngredientRow());
    document.getElementById('addDirection').addEventListener('click', () => addDirectionRow());
    
    document.getElementById('recipeForm').addEventListener('submit', saveRecipe);
    
    document.getElementById('addAnother').addEventListener('click', resetForm);
    
    // Initialize
    if (isAuthenticated()) {
      showPinOverlay(false);
    } else {
      showPinOverlay(true);
      document.getElementById('pinInput').focus();
    }
    
    checkApiKey();
  </script>
</body>
</html>

